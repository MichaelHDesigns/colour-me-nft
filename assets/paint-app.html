<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paint DApp</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #333;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .iframe-container {
            width: 100%;
            height: 1000px;
            border: none;
        }
        .status {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            font-size: 14px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¨ Paint DApp</h1>
            <p>Create, save, and mint your artwork on Polygon</p>
        </div>
        
        <iframe 
            src="paint.svg" 
            class="iframe-container"
            id="paint-iframe"
            title="Paint Application">
        </iframe>
        
        <div class="status" id="status">
            <span id="status-text">Loading paint app...</span>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('paint-iframe');
        const status = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        
        let walletConnected = false;
        let currentAccount = null;
        
        // Blockchain constants
        const POLYGON_CHAIN_ID = '0x89';
        const POLYGON_NETWORK = {
            chainId: POLYGON_CHAIN_ID,
            chainName: 'Polygon Mainnet',
            nativeCurrency: {
                name: 'Polygon PoS',
                symbol: 'POL',
                decimals: 18
            },
            rpcUrls: ['https://polygon-bor-rpc.publicnode.com/'],
            blockExplorerUrls: ['https://polygonscan.com/']
        };
        
        // Blockchain functions
        async function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed!');
                return true;
            } else {
                console.log('MetaMask is not installed');
                return false;
            }
        }
        
        async function connectWallet() {
            if (!await checkMetaMask()) return false;
            
            try {
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    walletConnected = true;
                    updateStatus('Wallet connected: ' + currentAccount.substring(0, 6) + '...' + currentAccount.substring(38), 'connected');
                    console.log('Wallet connected:', currentAccount);
                    return true;
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                updateStatus('Failed to connect wallet: ' + error.message, 'disconnected');
            }
            return false;
        }
        
        async function switchToPolygon() {
            if (!walletConnected) {
                if (!await connectWallet()) return false;
            }
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_CHAIN_ID }],
                });
                console.log('Switched to Polygon');
                updateStatus('Connected to Polygon network', 'connected');
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [POLYGON_NETWORK],
                        });
                        console.log('Added and switched to Polygon');
                        updateStatus('Added and connected to Polygon network', 'connected');
                        return true;
                    } catch (addError) {
                        console.error('Error adding Polygon network:', addError);
                        updateStatus('Failed to add Polygon network: ' + addError.message, 'disconnected');
                        return false;
                    }
                } else {
                    console.error('Error switching to Polygon:', switchError);
                    updateStatus('Failed to switch to Polygon: ' + switchError.message, 'disconnected');
                    return false;
                }
            }
        }
        
        function updateStatus(message, type) {
            statusText.textContent = message;
            status.className = 'status ' + type;
        }
        
        // Listen for messages from the SVG iframe
        window.addEventListener('message', async function(event) {
            // Verify the message is from our iframe
            if (event.source !== iframe.contentWindow) return;
            
            const { type, data } = event.data;
            
            switch (type) {
                case 'SAVE_REQUEST':
                    console.log('Save request received from SVG');
                    const hasMetaMask = await checkMetaMask();
                    
                    if (hasMetaMask) {
                        const success = await switchToPolygon();
                        if (success) {
                            updateStatus('Blockchain ready, saving drawing...', 'connected');
                            // Send success message back to SVG
                            iframe.contentWindow.postMessage({
                                type: 'SAVE_RESPONSE',
                                success: true,
                                message: 'Blockchain ready'
                            }, '*');
                        } else {
                            updateStatus('Blockchain not ready, saving locally only...', 'disconnected');
                            iframe.contentWindow.postMessage({
                                type: 'SAVE_RESPONSE',
                                success: false,
                                message: 'Blockchain not ready'
                            }, '*');
                        }
                    } else {
                        updateStatus('MetaMask not available, saving locally only...', 'disconnected');
                        iframe.contentWindow.postMessage({
                            type: 'SAVE_RESPONSE',
                            success: false,
                            message: 'MetaMask not available'
                        }, '*');
                    }
                    break;
                    
                case 'EXPORT_REQUEST':
                    console.log('Export request received from SVG');
                    // Handle export if needed
                    break;
                    
                case 'CLEAR_REQUEST':
                    console.log('Clear request received from SVG');
                    updateStatus('Canvas cleared', 'disconnected');
                    break;
            }
        });
        
        // Initialize
        window.addEventListener('load', function() {
            updateStatus('Paint app loaded, ready to create!', 'disconnected');
        });
    </script>
</body>
</html> 